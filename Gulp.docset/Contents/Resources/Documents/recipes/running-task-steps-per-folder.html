<!DOCTYPE html>
<html lang="es">
<head>
	<title>running-task-steps-per-folder</title>
    <meta charset="utf-8">
	<link rel="stylesheet" href="style.css" />
</head>
<body>
<h1>Generating a file per folder</h1>

<p>If you have a set of folders, and wish to perform a set of tasks on each, for instance</p>

<pre><code>/scripts
/scripts/jquery/*.js
/scripts/angularjs/*.js
</code></pre>

<p>and want to end up with</p>

<pre><code>/scripts
/scripts/jquery.min.js
/scripts/angularjs.min.js
</code></pre>

<p>and so on, you need to know a little more NodeJS and event streams. </p>

<p>``` javascript
var fs = require('fs');
var path = require('path');
var es = require('event-stream');
var gulp = require('gulp');
var concat = require('gulp-concat');
var rename = require('gulp-rename');
var uglify = require('gulp-uglify');</p>

<p>var scriptsPath = './src/scripts/';</p>

<p>function getFolders(dir) {
    return fs.readdirSync(dir)
      .filter(function(file) {
        return fs.statSync(path.join(dir, file)).isDirectory();
      });
}</p>

<p>gulp.task('scripts', function() { 
   var folders = getFolders(scriptsPath);</p>

<p>var tasks = folders.map(function(folder) {
      // concat into foldername.js
      // write to output
      // minify
      // rename to folder.min.js
      // write to output again
      return gulp.src(path.join(scriptsPath, folder, '/*.js'))
        .pipe(concat(folder + '.js'))
        .pipe(gulp.dest(scriptsPath))
        .pipe(uglify())
        .pipe(rename(folder + '.min.js'))
        .pipe(gulp.dest(scriptsPath));
   });</p>

<p>return es.concat.apply(null, tasks);
});
```</p>

<p>A few notes with this:</p>

<ul>
<li>folders.map - executes the function once per folder, and returns the async stream</li>
<li>es.concat - combines the streams and ends only when all streams emitted end</li>
<li>the call to .apply(null, args) is needed as es.concat expects arguments not an array</li>
</ul>
</body>
</html>
